<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Equipos 5v5 — Generador equilibrado</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="w-full max-w-none mx-auto p-4 md:p-6 space-y-6 md:min-h-screen">
    <header class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
      <h1 class="text-2xl font-semibold tracking-tight text-center md:text-left">Generador de equipos Brafaz</h1>
      <div class="flex flex-col gap-2 sm:flex-row sm:flex-wrap md:flex-nowrap md:justify-end">
        <button id="openFormBtn" class="w-full sm:w-auto px-3 py-2 rounded-xl bg-emerald-600 text-white text-sm">Nuevo jugador</button>
      </div>
    </header>
    <nav id="mobileNav" class="md:hidden -mx-4 px-4" aria-label="Navegación rápida">
      <div class="flex gap-2 overflow-x-auto pb-2 snap-x snap-mandatory">
        <button type="button" data-scroll-target="#registradosPanel" class="shrink-0 snap-start px-3 py-2 rounded-xl border border-slate-200 bg-white text-sm font-medium whitespace-nowrap text-slate-700">Registrados</button>
        <button type="button" data-scroll-target="#apuntadosPanel" class="shrink-0 snap-start px-3 py-2 rounded-xl border border-slate-200 bg-white text-sm font-medium whitespace-nowrap text-slate-700">Convocados</button>
        <button type="button" data-scroll-target="#teamAPanel" class="shrink-0 snap-start px-3 py-2 rounded-xl border border-slate-200 bg-white text-sm font-medium whitespace-nowrap text-slate-700">Equipo Blanco</button>
        <button type="button" data-scroll-target="#teamBPanel" class="shrink-0 snap-start px-3 py-2 rounded-xl border border-slate-200 bg-white text-sm font-medium whitespace-nowrap text-slate-700">Equipo Peto</button>
      </div>
    </nav>

    <p class="text-xs text-slate-600">
      Escala de nivel (0–100): <b>0</b> = <i>Incapaz</i> · <b>100</b> = <i>Dios</i>.
    </p>

    <!-- barra acciones equipos -->
    <div class="flex flex-col gap-2 sm:flex-row sm:justify-end mb-4">
      <button id="makeTeamsBtn" class="w-full sm:w-auto px-4 py-2 rounded-xl bg-indigo-600 text-white">Crear equipos</button>
      <button id="shuffleTeamsBtn" class="w-full sm:w-auto px-4 py-2 rounded-xl bg-white border border-slate-200">Otra versión</button>
    </div>

    <!-- layout 4 columnas desde tablet -->
    <section id="layout4col" class="grid grid-cols-1 gap-4 md:grid-cols-4 md:gap-6 md:h-[calc(100vh-160px)]">
      <!-- Registrados -->
      <div id="registradosPanel" class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 md:p-6 md:h-full md:overflow-auto scroll-mt-28">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-medium">Registrados</h2>
          <input id="searchInput" placeholder="Buscar…" class="px-3 py-2 rounded-xl border border-slate-200 text-sm" />
        </div>
        <div id="playersGrid" class="grid grid-cols-1 gap-3"></div>
        <p class="text-xs text-slate-500 mt-3">Arrastra una ficha a “Apuntados” o pulsa “Apuntar”. También puedes soltar aquí para devolver desde “Apuntados”.</p>
      </div>

      <!-- Apuntados -->
      <div id="apuntadosPanel" class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 md:p-6 md:h-full md:overflow-auto scroll-mt-28">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-medium">Convocados</h2>
          <button id="clearApuntadosBtn" class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-sm">Vaciar</button>
        </div>
        <div id="apuntadosDrop" class="min-h-40 rounded-xl border-2 border-dashed border-slate-300 p-3 grid grid-cols-1 gap-3"></div>
        <p class="text-xs text-slate-500 mt-3">Necesitas exactamente 10 para generar dos equipos.</p>
      </div>

      <!-- Equipo A -->
      <div id="teamAPanel" class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 md:p-6 md:h-full md:overflow-auto scroll-mt-28">
        <div class="flex items-start justify-between mb-3 gap-3">
          <div class="w-full">
            <h2 class="text-lg font-medium">Blanco</h2>
            <div id="teamAStats" class="mt-3 text-slate-600"></div>
          </div>
          <div id="teamARadar" class="w-16 h-16 shrink-0"></div>
        </div>
        <div id="teamA" class="grid grid-cols-1 gap-3"></div>
        <p id="sumA" class="mt-3 text-xs text-slate-500"></p>
      </div>

      <!-- Equipo B -->
      <div id="teamBPanel" class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 md:p-6 md:h-full md:overflow-auto scroll-mt-28">
        <div class="flex items-start justify-between mb-3 gap-3">
          <div class="w-full">
            <h2 class="text-lg font-medium">Peto</h2>
            <div id="teamBStats" class="mt-3 text-slate-600"></div>
          </div>
          <div id="teamBRadar" class="w-16 h-16 shrink-0"></div>
        </div>
        <div id="teamB" class="grid grid-cols-1 gap-3"></div>
        <p id="sumB" class="mt-3 text-xs text-slate-500"></p>
      </div>
    </section>

    <section id="comparisonPanel" class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 md:p-6 space-y-4">
      <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
        <h2 class="text-lg font-medium text-slate-900">Comparativa de perfiles</h2>
        <div id="comparisonLegend" class="flex flex-wrap items-center gap-3 text-sm text-slate-600"></div>
      </div>
      <div id="comparisonRadar" class="relative w-full h-64 md:h-72 flex items-center justify-center">
        <div class="text-sm text-slate-400">Genera ambos equipos para ver la comparación.</div>
      </div>
      <p id="comparisonNote" class="text-xs text-slate-500"></p>
    </section>
  </div>

  <!-- MODAL NUEVO/EDITAR JUGADOR (radar solo aquí) -->
  <div id="formModal" class="fixed inset-0 hidden items-end md:items-center justify-center bg-black/40 p-4 sm:p-6 z-50 overflow-y-auto">
    <div class="bg-white rounded-t-3xl md:rounded-2xl max-w-3xl w-full p-5 sm:p-6 shadow-lg max-h-[calc(100vh-2rem)] overflow-y-auto">
      <div class="flex items-center justify-between mb-3">
        <h3 id="formTitle" class="text-lg font-semibold">Registrar nuevo jugador</h3>
        <button id="closeFormBtn" class="text-slate-500">✕</button>
      </div>

      <form id="playerForm" class="grid md:grid-cols-2 gap-6">
        <input type="hidden" name="editingId" />

        <!-- Columna izquierda: datos + sliders -->
        <div class="space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <input required name="nombre" placeholder="Nombre" class="w-full px-3 py-2 rounded-xl border border-slate-200" />
            <input required name="apellido" placeholder="Apellido" class="w-full px-3 py-2 rounded-xl border border-slate-200" />
          </div>
          <div class="grid grid-cols-3 gap-3">
            <input required name="nacimiento" type="number" min="1940" max="2100" placeholder="Año de nacimiento" class="w-full px-3 py-2 rounded-xl border border-slate-200" />
            <input name="edad_calc" type="text" placeholder="Edad" disabled class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50" />
            <div></div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <input required name="peso" type="number" min="20" max="200" step="0.1" placeholder="Peso (kg)" class="w-full px-3 py-2 rounded-xl border border-slate-200" />
            <input required name="altura" type="number" min="120" max="230" step="0.5" placeholder="Altura (cm)" class="w-full px-3 py-2 rounded-xl border border-slate-200" />
          </div>

          <div class="rounded-xl border border-slate-200 bg-slate-50 p-4 flex items-center justify-between gap-4">
            <div>
              <p class="text-xs uppercase tracking-[0.3em] text-slate-500">Media</p>
              <p id="formAverageValue" class="text-4xl font-semibold leading-none text-slate-900">50</p>
            </div>
            <div id="formMiniRadar" class="w-16 h-16 sm:w-20 sm:h-20"></div>
          </div>

          <!-- Sliders 0–100 (nuevos parámetros, con número y emoji) -->
          <div class="space-y-4">
            <div class="space-y-2">
              <label class="block text-sm">Disparo (0–100) ⚽</label>
              <div class="flex items-center gap-3">
                <input required name="disparo" type="range" min="0" max="100" value="50" class="flex-1" />
                <input name="disparo_num" type="number" min="0" max="100" value="50" class="w-20 px-2 py-1 rounded-lg border border-slate-200 text-sm" />
              </div>
              <div class="mt-2 grid grid-cols-5 gap-2 text-[10px] text-slate-500 text-center">
                <div class="flex flex-col items-center gap-1">
                  <span class="h-2 w-px bg-slate-300"></span>
                  <span>0 · Incapaz</span>
                </div>
                <div class="flex flex-col items-center gap-1">
                  <span class="h-2 w-px bg-slate-300"></span>
                  <span>25 · Lerdo</span>
                </div>
                <div class="flex flex-col items-center gap-1">
                  <span class="h-2 w-px bg-slate-300"></span>
                  <span>50 · No destaca</span>
                </div>
                <div class="flex flex-col items-center gap-1">
                  <span class="h-2 w-px bg-slate-300"></span>
                  <span>75 · La toca</span>
                </div>
                <div class="flex flex-col items-center gap-1">
                  <span class="h-2 w-px bg-slate-300"></span>
                  <span>100 · Dios</span>
                </div>
              </div>
              <p class="text-xs text-slate-500">Precisión y potencia del remate a portería.</p>
            </div>
            <div class="space-y-2">
              <label class="block text-sm">Técnica (0–100) 🎯</label>
              <div class="flex items-center gap-3">
                <input required name="tecnica" type="range" min="0" max="100" value="50" class="flex-1" />
                <input name="tecnica_num" type="number" min="0" max="100" value="50" class="w-20 px-2 py-1 rounded-lg border border-slate-200 text-sm" />
              </div>
              <div class="mt-2 grid grid-cols-5 gap-2 text-[10px] text-slate-500 text-center">
                <div class="flex flex-col items-center gap-1">
                  <span class="h-2 w-px bg-slate-300"></span>
                  <span>0 · Incapaz</span>
                </div>
                <div class="flex flex-col items-center gap-1">
                  <span class="h-2 w-px bg-slate-300"></span>
                  <span>25 · Lerdo</span>
                </div>
                <div class="flex flex-col items-center gap-1">
                  <span class="h-2 w-px bg-slate-300"></span>
                  <span>50 · No destaca</span>
                </div>
                <div class="flex flex-col items-center gap-1">
                  <span class="h-2 w-px bg-slate-300"></span>
                  <span>75 · La toca</span>
                </div>
                <div class="flex flex-col items-center gap-1">
                  <span class="h-2 w-px bg-slate-300"></span>
                  <span>100 · Dios</span>
                </div>
              </div>
              <p class="text-xs text-slate-500">Control, regate y visión en espacios reducidos.</p>
            </div>
            <div class="space-y-2">
              <label class="block text-sm">Velocidad (0–100) ⚡</label>
              <div class="flex items-center gap-3">
                <input required name="velocidad" type="range" min="0" max="100" value="50" class="flex-1" />
                <input name="velocidad_num" type="number" min="0" max="100" value="50" class="w-20 px-2 py-1 rounded-lg border border-slate-200 text-sm" />
              </div>
              <div class="mt-2 grid grid-cols-5 gap-2 text-[10px] text-slate-500 text-center">
                <div class="flex flex-col items-center gap-1">
                  <span class="h-2 w-px bg-slate-300"></span>
                  <span>0 · Incapaz</span>
                </div>
                <div class="flex flex-col items-center gap-1">
                  <span class="h-2 w-px bg-slate-300"></span>
                  <span>25 · Lerdo</span>
                </div>
                <div class="flex flex-col items-center gap-1">
                  <span class="h-2 w-px bg-slate-300"></span>
                  <span>50 · No destaca</span>
                </div>
                <div class="flex flex-col items-center gap-1">
                  <span class="h-2 w-px bg-slate-300"></span>
                  <span>75 · La toca</span>
                </div>
                <div class="flex flex-col items-center gap-1">
                  <span class="h-2 w-px bg-slate-300"></span>
                  <span>100 · Dios</span>
                </div>
              </div>
              <p class="text-xs text-slate-500">Aceleración y capacidad de ganar metros al rival.</p>
            </div>
            <div class="space-y-2">
              <label class="block text-sm">Resistencia (0–100) 🫁</label>
              <div class="flex items-center gap-3">
                <input required name="resistencia" type="range" min="0" max="100" value="50" class="flex-1" />
                <input name="resistencia_num" type="number" min="0" max="100" value="50" class="w-20 px-2 py-1 rounded-lg border border-slate-200 text-sm" />
              </div>
              <div class="mt-2 grid grid-cols-5 gap-2 text-[10px] text-slate-500 text-center">
                <div class="flex flex-col items-center gap-1">
                  <span class="h-2 w-px bg-slate-300"></span>
                  <span>0 · Incapaz</span>
                </div>
                <div class="flex flex-col items-center gap-1">
                  <span class="h-2 w-px bg-slate-300"></span>
                  <span>25 · Lerdo</span>
                </div>
                <div class="flex flex-col items-center gap-1">
                  <span class="h-2 w-px bg-slate-300"></span>
                  <span>50 · No destaca</span>
                </div>
                <div class="flex flex-col items-center gap-1">
                  <span class="h-2 w-px bg-slate-300"></span>
                  <span>75 · La toca</span>
                </div>
                <div class="flex flex-col items-center gap-1">
                  <span class="h-2 w-px bg-slate-300"></span>
                  <span>100 · Dios</span>
                </div>
              </div>
              <p class="text-xs text-slate-500">Aguante físico y ritmo constante durante el partido.</p>
            </div>
            <div class="space-y-2">
              <label class="block text-sm">Sacrificio (0–100) 🔥</label>
              <div class="flex items-center gap-3">
                <input required name="sacrificio" type="range" min="0" max="100" value="50" class="flex-1" />
                <input name="sacrificio_num" type="number" min="0" max="100" value="50" class="w-20 px-2 py-1 rounded-lg border border-slate-200 text-sm" />
              </div>
              <div class="mt-2 grid grid-cols-5 gap-2 text-[10px] text-slate-500 text-center">
                <div class="flex flex-col items-center gap-1">
                  <span class="h-2 w-px bg-slate-300"></span>
                  <span>0 · Incapaz</span>
                </div>
                <div class="flex flex-col items-center gap-1">
                  <span class="h-2 w-px bg-slate-300"></span>
                  <span>25 · Lerdo</span>
                </div>
                <div class="flex flex-col items-center gap-1">
                  <span class="h-2 w-px bg-slate-300"></span>
                  <span>50 · No destaca</span>
                </div>
                <div class="flex flex-col items-center gap-1">
                  <span class="h-2 w-px bg-slate-300"></span>
                  <span>75 · La toca</span>
                </div>
                <div class="flex flex-col items-center gap-1">
                  <span class="h-2 w-px bg-slate-300"></span>
                  <span>100 · Dios</span>
                </div>
              </div>
              <p class="text-xs text-slate-500">Compromiso defensivo y esfuerzo sin balón.</p>
            </div>
            <div class="space-y-2">
              <label class="block text-sm">Físico (0–100) 💪</label>
              <div class="flex items-center gap-3">
                <input required name="fisico" type="range" min="0" max="100" value="50" class="flex-1" />
                <input name="fisico_num" type="number" min="0" max="100" value="50" class="w-20 px-2 py-1 rounded-lg border border-slate-200 text-sm" />
              </div>
              <div class="mt-2 grid grid-cols-5 gap-2 text-[10px] text-slate-500 text-center">
                <div class="flex flex-col items-center gap-1">
                  <span class="h-2 w-px bg-slate-300"></span>
                  <span>0 · Incapaz</span>
                </div>
                <div class="flex flex-col items-center gap-1">
                  <span class="h-2 w-px bg-slate-300"></span>
                  <span>25 · Lerdo</span>
                </div>
                <div class="flex flex-col items-center gap-1">
                  <span class="h-2 w-px bg-slate-300"></span>
                  <span>50 · No destaca</span>
                </div>
                <div class="flex flex-col items-center gap-1">
                  <span class="h-2 w-px bg-slate-300"></span>
                  <span>75 · La toca</span>
                </div>
                <div class="flex flex-col items-center gap-1">
                  <span class="h-2 w-px bg-slate-300"></span>
                  <span>100 · Dios</span>
                </div>
              </div>
              <p class="text-xs text-slate-500">Fortaleza en duelos, choques y juego aéreo.</p>
            </div>
          </div>
        </div>

        <!-- Columna derecha: radar -->
        <div class="hidden md:block">
          <div id="radarBox" class="w-full"></div>
        </div>

        <div class="col-span-2 flex items-center justify-between">
          <p class="text-xs text-slate-500">
            Se guarda en LocalStorage y, si elegiste carpeta, se escribe/actualiza la ficha .json. Escala: 0 = <i>Incapaz</i>, 100 = <i>Dios</i>.
          </p>
          <div class="flex gap-2">
            <button type="button" id="deletePlayerBtn" class="px-4 py-2 rounded-xl bg-rose-50 text-rose-700 border border-rose-200 hidden">Eliminar</button>
            <button type="button" id="cancelFormBtn" class="px-4 py-2 rounded-xl bg-white border border-slate-200">Cancelar</button>
            <button class="px-4 py-2 rounded-xl bg-emerald-600 text-white">Guardar</button>
          </div>
        </div>
      </form>
    </div>
  </div>

<script>
// --- SUPABASE CONFIG ---
const SUPABASE_URL = "https://rfbnkbicsuqfjcznscit.supabase.co"; 
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJmYm5rYmljc3VxZmpjem5zY2l0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3NTkwNDMsImV4cCI6MjA3NTMzNTA0M30.HfdI37LfvMtKlkU5MpvE6qzAyyO1-Gt9fR45uxPko5c";
const SUPABASE_BUCKET = "fichas";

let supa = null;
try {
  if (window.supabase && SUPABASE_URL && SUPABASE_ANON_KEY) {
    supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  }
} catch {}
/* ---------- Estado & utilidad ---------- */
const STORAGE_KEY = 'futbol_app_state_v1';

function defaultAppState(){
  return { players: [], apuntados: [], teamAIds: [], teamBIds: [], lastSeed: Date.now() };
}

function normalizeState(rawState){
  const fallback = defaultAppState();
  const base = (rawState && typeof rawState === 'object') ? rawState : {};
  const normalized = {
    ...base,
    players: Array.isArray(base.players) ? base.players : fallback.players,
    apuntados: Array.isArray(base.apuntados) ? base.apuntados : fallback.apuntados,
    teamAIds: Array.isArray(base.teamAIds) ? base.teamAIds : fallback.teamAIds,
    teamBIds: Array.isArray(base.teamBIds) ? base.teamBIds : fallback.teamBIds,
    lastSeed: Number.isFinite(base.lastSeed) ? base.lastSeed : fallback.lastSeed
  };
  return normalized;
}

let state = loadState();
ensureTeamArrays();
let fichasDirHandle = null;
const PARAM_KEYS = ['disparo','tecnica','velocidad','resistencia','sacrificio','fisico'];
const PARAM_ICONS = {
  disparo:'⚽',
  tecnica:'🎯',
  velocidad:'⚡',
  resistencia:'🫁',
  sacrificio:'🔥',
  fisico:'💪'
};
const clampStatValue = (value, fallback = 50) => {
  const num = Number(value);
  if (Number.isFinite(num)) {
    return Math.max(0, Math.min(100, num));
  }
  return fallback;
};

function loadState() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return normalizeState({});
  try { return normalizeState(JSON.parse(raw)); } catch { return normalizeState({}); }
}

function ensureTeamArrays(){
  if(!Array.isArray(state.teamAIds)) state.teamAIds = [];
  if(!Array.isArray(state.teamBIds)) state.teamBIds = [];
}
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
function uuid(){ return 'xxxxxx'.replace(/x/g, ()=> (Math.random()*36|0).toString(36)); }

function paramsObj(p){
  const tieneNuevos = p.disparo!=null || p.fisico!=null;
  const disparo = clampStatValue(tieneNuevos ? p.disparo : (p.vision ?? p.dribling ?? p.tecnica), 50);
  const tecnica = clampStatValue(p.tecnica, 50);
  const velocidad = clampStatValue(p.velocidad, 50);
  const resistencia = clampStatValue(p.resistencia, 50);
  const sacrificio = clampStatValue(p.sacrificio, 50);
  let fisico;
  if (p.fisico != null) {
    fisico = clampStatValue(p.fisico, 50);
  } else if (p.peso != null) {
    const pesoNum = Number(p.peso);
    fisico = Number.isFinite(pesoNum) ? Math.max(0, Math.min(100, Math.round(pesoNum))) : 50;
  } else {
    fisico = 50;
  }
  return {disparo, tecnica, velocidad, resistencia, sacrificio, fisico};
}
function averageParams(players){
  if(!players || !players.length) return null;
  const totals = PARAM_KEYS.reduce((acc,key)=>{ acc[key]=0; return acc; }, {});
  players.forEach(p=>{
    const pr = paramsObj(p);
    PARAM_KEYS.forEach(key=>{ totals[key]+=pr[key]; });
  });
  const count = players.length;
  PARAM_KEYS.forEach(key=>{ totals[key] = +(totals[key]/count).toFixed(2); });
  return totals;
}
function avgSkill(p){
  const v = Object.values(paramsObj(p));
  return +(v.reduce((a,b)=>a+b,0)/v.length).toFixed(2);
}
function levelInt(p){ return Math.round(avgSkill(p)); }
function ageFromYear(y){ const Y=+y||0; if(!Y) return 0; return new Date().getFullYear()-Y; }

function average(values){
  const valid = values.filter(v=> Number.isFinite(v));
  if(!valid.length) return 0;
  return valid.reduce((sum, value)=> sum + value, 0) / valid.length;
}

function averagePositive(values){
  const valid = values.filter(v=> Number.isFinite(v) && v>0);
  if(!valid.length) return null;
  return valid.reduce((sum, value)=> sum + value, 0) / valid.length;
}

function teamSkillSum(players = []){
  return players.reduce((sum, player)=> sum + avgSkill(player), 0);
}

function teamSkillDiff(teamAPlayers = [], teamBPlayers = []){
  const totalA = teamSkillSum(teamAPlayers);
  const totalB = teamSkillSum(teamBPlayers);
  return Math.abs(totalA - totalB);
}

const TEAM_BALANCE_WEIGHTS = Object.freeze({
  skill: 1,
  peso: 0,
  altura: 0
});
const TEAM_BALANCE_TOLERANCE = 1.5;

function balanceMetrics(teamAPlayers = [], teamBPlayers = []){
  const avgSkillA = average(teamAPlayers.map(avgSkill));
  const avgSkillB = average(teamBPlayers.map(avgSkill));

  const avgPesoA = averagePositive(teamAPlayers.map(p=> +p.peso));
  const avgPesoB = averagePositive(teamBPlayers.map(p=> +p.peso));

  const avgAlturaA = averagePositive(teamAPlayers.map(p=> +p.altura));
  const avgAlturaB = averagePositive(teamBPlayers.map(p=> +p.altura));

  const diffSkill = Math.abs(avgSkillA - avgSkillB);
  const diffPeso = (avgPesoA != null && avgPesoB != null) ? Math.abs(avgPesoA - avgPesoB) : null;
  const diffAltura = (avgAlturaA != null && avgAlturaB != null) ? Math.abs(avgAlturaA - avgAlturaB) : null;

  const total =
    diffSkill * TEAM_BALANCE_WEIGHTS.skill +
    (diffPeso ?? 0) * TEAM_BALANCE_WEIGHTS.peso +
    (diffAltura ?? 0) * TEAM_BALANCE_WEIGHTS.altura;

  return {
    total,
    detail: {
      skill: diffSkill,
      peso: diffPeso,
      altura: diffAltura
    },
    averages: {
      a: { skill: avgSkillA, peso: avgPesoA, altura: avgAlturaA },
      b: { skill: avgSkillB, peso: avgPesoB, altura: avgAlturaB }
    }
  };
}

function playersFromIds(ids){
  if(!Array.isArray(ids) || !ids.length) return [];
  const seen = new Set();
  const players = [];
  ids.forEach((id)=>{
    if(seen.has(id)) return;
    const player = state.players.find(p=>p.id===id);
    if(player){
      seen.add(id);
      players.push(player);
    }
  });
  return players;
}

function movePlayerToTeam(playerId, targetTeam){
  ensureTeamArrays();
  if(!playerId) return false;
  const playerExists = state.players.some(p=>p.id===playerId);
  if(!playerExists) return false;
  const team = targetTeam === 'A' ? 'A' : (targetTeam === 'B' ? 'B' : null);
  if(!team) return false;

  const isInA = state.teamAIds.includes(playerId);
  const isInB = state.teamBIds.includes(playerId);
  let changed = false;

  if(team === 'A'){
    if(!isInA){
      state.teamAIds.push(playerId);
      changed = true;
    }
    const prevLen = state.teamBIds.length;
    state.teamBIds = state.teamBIds.filter(id=>id!==playerId);
    if(state.teamBIds.length !== prevLen) changed = true;
  } else {
    if(!isInB){
      state.teamBIds.push(playerId);
      changed = true;
    }
    const prevLen = state.teamAIds.length;
    state.teamAIds = state.teamAIds.filter(id=>id!==playerId);
    if(state.teamAIds.length !== prevLen) changed = true;
  }

  if(changed){
    saveState();
    renderTeams();
  }
  return changed;
}

function levelColor(n){
  const clamp = (x,min,max)=> Math.max(min, Math.min(max, x));
  n = clamp(n, 0, 100);
  const lerp = (a,b,t)=> Math.round(a + (b-a)*t);
  const toHex = (r,g,b)=> '#' + [r,g,b].map(x=> x.toString(16).padStart(2,'0')).join('');
  const W=[255,255,255], G=[16,185,129], R=[239,68,68];
  if(n<=50){ const t=n/50; return toHex(lerp(W[0],G[0],t), lerp(W[1],G[1],t), lerp(W[2],G[2],t)); }
  const t=(n-50)/50; return toHex(lerp(G[0],R[0],t), lerp(G[1],R[1],t), lerp(G[2],R[2],t));
}

/* Radar con margen extra y emojis en etiquetas */
function radarSVG(p, size = 220, levels = 4){
  const pr = paramsObj(p);
  const labels = ['DIS⚽','TEC🎯','VEL⚡','RES🫁','SAC🔥','FIS💪'];
  const vals = [pr.disparo, pr.tecnica, pr.velocidad, pr.resistencia, pr.sacrificio, pr.fisico].map(v=>{
    const num = Number(v);
    return Number.isFinite(num) ? Math.max(0, Math.min(100, num)) : 0;
  });
  const margin = 40; // margen generoso para que etiquetas no se corten
  const inner = size;
  const W = inner + margin*2, H = inner + margin*2;
  const cx = margin + inner/2, cy = margin + inner/2; const pad = 12; const R = (inner/2) - pad; const N = vals.length; const tau = Math.PI*2;
  const angleAt = (i)=> -Math.PI/2 + i * (tau/N);
  const pt = (r,a)=> [cx + r*Math.cos(a), cy + r*Math.sin(a)];
  const grid = [];
  for (let l = 1; l <= levels; l++){
    const t = l/levels; const r = R*t; const points = [];
    for (let i=0;i<N;i++){ const a = angleAt(i); const [x,y] = pt(r,a); points.push(`${x.toFixed(1)},${y.toFixed(1)}`); }
    grid.push(`<polygon points="${points.join(' ')}" fill="none" stroke="#e5e7eb" stroke-width="1" />`);
  }
  const polyPts = [];
  for (let i=0;i<N;i++){
    const a = angleAt(i); const r = R * (vals[i]/100); const [x,y] = pt(r,a); polyPts.push(`${x.toFixed(1)},${y.toFixed(1)}`);
  }
  const shape = `<polygon points="${polyPts.join(' ')}" fill="rgba(20,184,166,0.18)" stroke="#14b8a6" stroke-width="2" />`;
  const axes = []; const texts = [];
  const labelRadius = R + 24;
  for (let i=0;i<N;i++){
    const a = angleAt(i); const [x,y] = pt(R,a);
    axes.push(`<line x1="${cx}" y1="${cy}" x2="${x.toFixed(1)}" y2="${y.toFixed(1)}" stroke="#f1f5f9" stroke-width="1" />`);
    const [tx,ty] = pt(labelRadius, a);
    texts.push(`<text x="${tx.toFixed(1)}" y="${ty.toFixed(1)}" text-anchor="middle" dominant-baseline="middle" font-size="12" fill="#334155">${labels[i]} ${Math.round(vals[i])}</text>`);
  }
  return `<svg width="100%" height="${H}" viewBox="0 0 ${W} ${H}" aria-hidden="true" style="overflow:visible">${grid.join('')}${axes.join('')}${shape}${texts.join('')}</svg>`;
}

function radarMiniSVG(source, size = 80){
  if(!source) return '';
  const params = PARAM_KEYS.every(key => Object.prototype.hasOwnProperty.call(source, key)) ? source : paramsObj(source);
  const vals = PARAM_KEYS.map(key => {
    const num = Number(params[key]);
    return Number.isFinite(num) ? Math.max(0, Math.min(100, num)) : 0;
  });
  const margin = 6;
  const inner = size;
  const W = inner + margin*2, H = inner + margin*2;
  const cx = margin + inner/2, cy = margin + inner/2;
  const R = inner/2;
  const levels = 3;
  const N = vals.length;
  const tau = Math.PI*2;
  const angleAt = (i)=> -Math.PI/2 + i * (tau/N);
  const pt = (r,a)=> [cx + r*Math.cos(a), cy + r*Math.sin(a)];
  const grid = [];
  for(let l=1; l<=levels; l++){
    const t = l/levels; const r = R*t; const points = [];
    for(let i=0;i<N;i++){ const a=angleAt(i); const [x,y]=pt(r,a); points.push(`${x.toFixed(1)},${y.toFixed(1)}`); }
    grid.push(`<polygon points="${points.join(' ')}" fill="none" stroke="rgba(148,163,184,0.35)" stroke-width="0.8" />`);
  }
  const polyPts = [];
  for(let i=0;i<N;i++){
    const a=angleAt(i); const r=R*(vals[i]/100); const [x,y]=pt(r,a); polyPts.push(`${x.toFixed(1)},${y.toFixed(1)}`);
  }
  const axes = [];
  for(let i=0;i<N;i++){
    const a=angleAt(i); const [x,y]=pt(R,a);
    axes.push(`<line x1="${cx}" y1="${cy}" x2="${x.toFixed(1)}" y2="${y.toFixed(1)}" stroke="rgba(148,163,184,0.2)" stroke-width="0.6" />`);
  }
  const shape = `<polygon points="${polyPts.join(' ')}" fill="rgba(20,184,166,0.2)" stroke="#14b8a6" stroke-width="1.4" />`;
  return `<svg width="100%" height="100%" viewBox="0 0 ${W} ${H}" aria-hidden="true" style="overflow:visible">${grid.join('')}${axes.join('')}${shape}</svg>`;
}

function radarOverlaySVG(avgA, avgB, size = 260){
  if(!avgA && !avgB) return '';
  const labels = ['Disparo','Tecnica','Velocidad','Resistencia','Sacrificio','Fisico'];
  const getValues = (dataset)=> PARAM_KEYS.map(key=>{
    const num = dataset && Number(dataset[key]);
    return Number.isFinite(num) ? Math.max(0, Math.min(100, num)) : 0;
  });
  const valsA = getValues(avgA);
  const valsB = getValues(avgB);
  const margin = 36;
  const inner = size;
  const W = inner + margin*2;
  const H = inner + margin*2;
  const cx = margin + inner/2;
  const cy = margin + inner/2;
  const R = inner/2;
  const levels = 4;
  const N = PARAM_KEYS.length;
  const tau = Math.PI*2;
  const angleAt = (i)=> -Math.PI/2 + i * (tau/N);
  const pt = (r,a)=> [cx + r*Math.cos(a), cy + r*Math.sin(a)];
  const polygonPoints = (vals)=> vals.map((value, idx)=>{
    const angle = angleAt(idx);
    const radius = R * (value/100);
    const [x,y] = pt(radius, angle);
    return `${x.toFixed(1)},${y.toFixed(1)}`;
  }).join(' ');

  const grid = [];
  for(let l=1;l<=levels;l++){
    const t = l/levels;
    const r = R*t;
    const points = [];
    for(let i=0;i<N;i++){
      const angle = angleAt(i);
      const [x,y] = pt(r, angle);
      points.push(`${x.toFixed(1)},${y.toFixed(1)}`);
    }
    grid.push(`<polygon points="${points.join(' ')}" fill="none" stroke="rgba(148,163,184,0.3)" stroke-width="1" />`);
  }

  const axes = [];
  const texts = [];
  const labelRadius = R + 24;
  for(let i=0;i<N;i++){
    const angle = angleAt(i);
    const [x,y] = pt(R, angle);
    axes.push(`<line x1="${cx.toFixed(1)}" y1="${cy.toFixed(1)}" x2="${x.toFixed(1)}" y2="${y.toFixed(1)}" stroke="rgba(148,163,184,0.2)" stroke-width="1" />`);
    const [tx,ty] = pt(labelRadius, angle);
    texts.push(`<text x="${tx.toFixed(1)}" y="${ty.toFixed(1)}" text-anchor="middle" dominant-baseline="middle" font-size="12" fill="#475569">${labels[i]}</text>`);
  }

  const shapeA = avgA ? `<polygon points="${polygonPoints(valsA)}" fill="rgba(37,99,235,0.28)" stroke="#2563eb" stroke-width="2" stroke-linejoin="round" />` : '';
  const shapeB = avgB ? `<polygon points="${polygonPoints(valsB)}" fill="rgba(249,115,22,0.28)" stroke="#f97316" stroke-width="2" stroke-linejoin="round" />` : '';

  return `<svg width="100%" height="${H}" viewBox="0 0 ${W} ${H}" aria-hidden="true" style="overflow:visible">${grid.join('')}${shapeB}${shapeA}${axes.join('')}${texts.join('')}</svg>`;
}

/* ---------- Card unificada (compacta para listados y detallada en equipos) ---------- */
function playerCard(p, opts = {}) {
  const mediaInt = levelInt(p);
  const params = paramsObj(p);
  const ctx = opts.context || 'registry'; // registry | apuntados | team
  const draggable = opts.draggable !== false;
  const dataAttrs = [`data-drag-id="${p.id}"`, `data-context="${ctx}"`];

  if (ctx === 'team') {
    const paramsHtml = PARAM_KEYS.map((key) => {
      const icon = PARAM_ICONS[key];
      const val = Math.round(params[key] ?? 0);
      return `<div class="flex items-center gap-1"><span>${icon}</span><span class="tabular-nums font-medium text-slate-700">${val}</span></div>`;
    }).join('');
    const miniRadar = radarMiniSVG(params, 70);
    if (opts.team) dataAttrs.push(`data-team="${opts.team}"`);
    const attrString = [draggable ? 'draggable="true"' : '', ...dataAttrs].filter(Boolean).join(' ');
    return `
      <div class="rounded-xl border border-slate-200 bg-white p-3 shadow-sm hover:shadow transition"
           ${attrString}>
        <div class="flex items-start justify-between gap-3">
          <div class="flex items-start gap-4">
            <div class="flex flex-col items-center sm:items-start gap-2">
              <div class="flex items-center gap-3">
                <div class="text-5xl font-black leading-none text-slate-900">${mediaInt}</div>
                <div class="w-14 h-14">${miniRadar || ''}</div>
              </div>
              <div class="flex items-center gap-1 text-[11px] uppercase tracking-[0.3em] text-slate-500"><span>⭐</span><span>Media</span></div>
            </div>
            <div class="space-y-2">
              <div class="font-semibold leading-tight text-slate-900">${p.nombre} ${p.apellido}</div>
              <div class="grid grid-cols-3 gap-x-3 gap-y-1 text-xs text-slate-600">
                ${paramsHtml}
              </div>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <button data-edit="${p.id}" title="Editar" class="text-slate-500 hover:text-slate-800">ⓘ</button>
          </div>
        </div>
        <div class="h-1.5 w-full rounded-b-[10px] mt-3" style="background-color:${levelColor(mediaInt)}"></div>
      </div>`;
  }

  const isRegistry = ctx === 'registry';
  const actionAttr = isRegistry ? `data-add="${p.id}"` : `data-remove="${p.id}"`;
  const actionTitle = isRegistry ? 'Apuntar' : 'Quitar';
  const actionLabel = isRegistry ? '+' : '-';
  const name = `${p.nombre} ${p.apellido}`.trim();

  const actionButtonClasses = isRegistry ? 'bg-emerald-600 hover:bg-emerald-700' : 'bg-rose-500 hover:bg-rose-600';
  const miniRadar = radarMiniSVG(params, 80);
  const attrString = [draggable ? 'draggable="true"' : '', ...dataAttrs].filter(Boolean).join(' ');

  return `
    <div class="rounded-xl border border-slate-200 bg-white px-3 py-2 shadow-sm hover:shadow transition"
         ${attrString}>
      <div class="flex items-center justify-between gap-3">
        <div class="flex items-center gap-3">
          <div class="relative w-20 h-20 shrink-0">
            <div class="absolute inset-0">${miniRadar || ''}</div>
            <div class="absolute inset-0 flex items-center justify-center">
              <span class="text-2xl font-semibold text-slate-900 leading-none">${mediaInt}</span>
            </div>
          </div>
          <div class="min-w-0">
            <p class="text-sm font-semibold text-slate-900 truncate">${name || 'Sin nombre'}</p>
          </div>
        </div>
        <div class="flex items-center gap-1">
          <button data-edit="${p.id}" title="Ver ficha" class="px-2 py-1 rounded-lg text-sm text-slate-500 hover:text-slate-800">ⓘ</button>
          <button ${actionAttr} title="${actionTitle}" class="w-8 h-8 rounded-full text-white text-lg leading-none flex items-center justify-center ${actionButtonClasses}">${actionLabel}</button>
        </div>
      </div>
      <div class="mt-2 h-1 w-full rounded-full" style="background-color:${levelColor(mediaInt)}"></div>
    </div>`;
}

/* ---------- Permisos carpeta (File System Access) ---------- */
async function verifyDirPermission(dirHandle){
  const opts={mode:'readwrite'};
  if ((await dirHandle.queryPermission(opts))==='granted') return true;
  return (await dirHandle.requestPermission(opts))==='granted';
}

/* ---------- Form modal (crear/editar) ---------- */
const openFormBtn=document.getElementById('openFormBtn');
const formModal=document.getElementById('formModal');
const formTitle=document.getElementById('formTitle');
const closeFormBtn=document.getElementById('closeFormBtn');
const cancelFormBtn=document.getElementById('cancelFormBtn');
const form=document.getElementById('playerForm');
const deleteBtn=document.getElementById('deletePlayerBtn');
const radarBox = document.getElementById('radarBox');
const formAverageEl = document.getElementById('formAverageValue');
const formMiniRadarEl = document.getElementById('formMiniRadar');

function showForm(){ formModal.classList.remove('hidden'); formModal.classList.add('flex'); }
function hideForm(){ formModal.classList.add('hidden'); formModal.classList.remove('flex'); form.reset(); form.elements.editingId.value=''; formTitle.textContent='Registrar nuevo jugador'; updateDeleteVisibility(); }
function updateDeleteVisibility(){ deleteBtn.classList.toggle('hidden', !form.elements.editingId.value); }

openFormBtn.addEventListener('click', ()=> {
  form.reset();
  form.elements.editingId.value='';
  formTitle.textContent='Registrar nuevo jugador';
  showForm();
  updateDeleteVisibility();
  ['disparo','tecnica','velocidad','resistencia','sacrificio','fisico'].forEach(bindRangeNumber);
  setTimeout(redrawRadarFromForm, 0);
});
closeFormBtn.addEventListener('click', hideForm);
cancelFormBtn.addEventListener('click', hideForm);
formModal.addEventListener('click', (e)=>{ if(e.target===formModal) hideForm(); });
form.addEventListener('input', updateDeleteVisibility);

/* slider <-> number vinculados + radar live */
function bindRangeNumber(name){
  const r = form.elements[name];
  const n = form.elements[name+"_num"];
  if(!r||!n) return;
  const syncRtoN = ()=>{ n.value = r.value; redrawRadarFromForm(); };
  const syncNtoR = ()=>{
    let v = Number(n.value);
    if(!Number.isFinite(v)) v = 0;
    v = Math.min(100, Math.max(0, v));
    r.value=v;
    n.value=v;
    redrawRadarFromForm();
  };
  r.addEventListener('input', syncRtoN);
  n.addEventListener('input', syncNtoR);
  n.value = r.value;
}

function redrawRadarFromForm(){
  const val = (k)=> +(form.elements[k+"_num"]?.value || form.elements[k]?.value || 50);
  const pr = { disparo:val('disparo'), tecnica:val('tecnica'), velocidad:val('velocidad'), resistencia:val('resistencia'), sacrificio:val('sacrificio'), fisico:val('fisico') };
  if(radarBox){
    radarBox.innerHTML = radarSVG(pr, 220, 4);
  }
  if(formAverageEl){
    const avgVal = Math.round(PARAM_KEYS.reduce((sum,key)=> sum + pr[key], 0) / PARAM_KEYS.length);
    formAverageEl.textContent = String(avgVal);
  }
  if(formMiniRadarEl){
    formMiniRadarEl.innerHTML = radarMiniSVG(pr, 64);
  }
}

['disparo','tecnica','velocidad','resistencia','sacrificio','fisico'].forEach(bindRangeNumber);

if(form.elements.nacimiento){
  form.elements.nacimiento.addEventListener('input', ()=>{
    const y = +form.elements.nacimiento.value;
    form.elements.edad_calc.value = y? (new Date().getFullYear()-y) : '';
  });
}

function fillForm(p){
  form.elements.editingId.value = p.id || '';
  form.elements.nombre.value = p.nombre || '';
  form.elements.apellido.value = p.apellido || '';
  form.elements.nacimiento.value = p.nacimiento || (p.edad ? (new Date().getFullYear()-p.edad) : '');
  form.elements.edad_calc.value = p.nacimiento ? (new Date().getFullYear()-p.nacimiento) : '';
  form.elements.peso.value = p.peso || '';
  form.elements.altura.value = p.altura || '';
  for (const k of ['disparo','tecnica','velocidad','resistencia','sacrificio','fisico']) {
    const val = (k==='disparo') ? (p.vision ?? p.dribling ?? p.tecnica ?? p[k]) : p[k];
    const v = (val!=null ? val : 50);
    if (form.elements[k]) form.elements[k].value = v;
    if (form.elements[k+"_num"]) form.elements[k+"_num"].value = v;
  }
  ['disparo','tecnica','velocidad','resistencia','sacrificio','fisico'].forEach(bindRangeNumber);
  updateDeleteVisibility();
  setTimeout(redrawRadarFromForm, 0);
}

form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd=new FormData(form);
  const editingId = fd.get('editingId');
  const getVal = (k)=> +(fd.get(k+"_num") || fd.get(k));
  const payload = {
    nombre: fd.get('nombre').toString().trim(),
    apellido: fd.get('apellido').toString().trim(),
    nacimiento: +fd.get('nacimiento'),
    peso: +fd.get('peso'),
    altura: +fd.get('altura'),
    disparo: getVal('disparo'),
    tecnica: getVal('tecnica'),
    velocidad: getVal('velocidad'),
    resistencia: getVal('resistencia'),
    sacrificio: getVal('sacrificio'),
    fisico: getVal('fisico')
  };

  let player;
  if (editingId) {
    const idx = state.players.findIndex(p=>p.id===editingId);
    if (idx>=0) {
      player = { ...state.players[idx], ...payload }; // conserva id/createdAt
      state.players[idx] = player;
    }
  } else {
    player = { id: uuid(), createdAt: new Date().toISOString(), ...payload };
    state.players.push(player);
  }

  saveState(); renderAll(); hideForm();
  try {
    const persistResult = await persistFicha(player);
    // guardamos de nuevo por si persistFicha añadió metadatos (remotePath, etc.)
    saveState();
    if (supa) {
      await syncPlayersFromSupabase({ silent: true });
    }
    if (persistResult.warning) {
      alert(persistResult.warning);
    }
  } catch (err) {
    console.error('No se pudo guardar la ficha en Supabase ni localmente:', err);
    alert('Jugador guardado solo en este dispositivo. La sincronización con Supabase falló.');
  }
});

  // --- Guardar ficha online en Supabase ---
async function writeFichaOnline(p, ficha){
  if(!supa) return null; // si no hay cliente supabase, no hacemos nada
  const path = p.remotePath || `${p.id}/${fichaFileName(p)}`;
  const blob = new Blob([JSON.stringify(ficha, null, 2)], { type: 'application/json' });
  const { error } = await supa
    .storage
    .from(SUPABASE_BUCKET)
    .upload(path, blob, { upsert: true, contentType: 'application/json' });
  if (error) throw error;
  return path;
}

async function persistFicha(player){
  const ficha = buildFichaJSON(player);
  if (supa) {
    try {
      const remotePath = await writeFichaOnline(player, ficha);
      if (remotePath) player.remotePath = remotePath;
      return { remote: true };
    } catch (err) {
      console.warn('Fallo subida online; intento carpeta local si existe.', err);
      if (fichasDirHandle && (await verifyDirPermission(fichasDirHandle))) {
        await writeFichaToDir(fichasDirHandle, player, ficha);
        return {
          remote: false,
          savedToDir: true,
          warning: 'Supabase no respondió. Se guardó el jugador en la carpeta local autorizada.'
        };
      }
      throw err;
    }
  }
  if (fichasDirHandle && (await verifyDirPermission(fichasDirHandle))) {
    await writeFichaToDir(fichasDirHandle, player, ficha);
    return { remote: false, savedToDir: true };
  }
  return {
    remote: false,
    localOnly: true,
    warning: 'Supabase no está configurado. El jugador queda guardado solo en este dispositivo.'
  };
}

async function deleteFichaOnline(player){
  if(!supa || !player) return false;
  const path = player.remotePath || `${player.id}/${fichaFileName(player)}`;
  const { error } = await supa
    .storage
    .from(SUPABASE_BUCKET)
    .remove([path]);
  if (error) throw error;
  return true;
}

deleteBtn.addEventListener('click', async ()=>{
  const id = form.elements.editingId.value; if(!id) return;
  if(!confirm('¿Eliminar este jugador?')) return;
  const player = state.players.find(x=> x.id===id);
  state.players = state.players.filter(x=> x.id!==id);
  state.apuntados = state.apuntados.filter(x=> x!==id);
  saveState(); renderAll(); hideForm();
  if (player) {
    try {
      await deleteFichaOnline(player);
      saveState();
      if (supa) {
        await syncPlayersFromSupabase({ silent: true });
      }
    } catch (err) {
      console.error('No se pudo eliminar la ficha en Supabase:', err);
      alert('El jugador se eliminó localmente, pero Supabase no está accesible ahora mismo.');
    }
  }
});

/* ---------- Fichas archivo ---------- */
function fichaFileName(p){
  const safe=(s)=> s.normalize('NFKD').replace(/[^\w\\-]+/g,'_');
  return `ficha_${safe(p.nombre)}_${safe(p.apellido)}_${p.id}.json`;
}
function buildFichaJSON(p){
  return {
    tipo:"ficha_jugador",
    nombre:p.nombre, apellido:p.apellido,
    anio_nacimiento:p.nacimiento, peso_kg:p.peso, altura_cm:p.altura,
    niveles:{
      disparo:p.disparo, tecnica:p.tecnica, velocidad:p.velocidad,
      resistencia:p.resistencia, sacrificio:p.sacrificio, fisico:p.fisico
    },
    puntuacion_media: avgSkill(p), id:p.id, creado:p.createdAt ?? new Date().toISOString(), version:1,
    escala_referencia:{ uno:"samuel del moral", diez:"David Casals" }
  };
}
async function writeFichaToDir(dirHandle,p,ficha){
  const fileHandle = await dirHandle.getFileHandle(fichaFileName(p), { create:true });
  const writable = await fileHandle.createWritable();
  await writable.write(JSON.stringify(ficha,null,2));
  await writable.close();
}

async function listAllBucketFiles(prefix=''){
  if (!supa) return [];
  const { data, error } = await supa
    .storage
    .from(SUPABASE_BUCKET)
    .list(prefix, { limit: 1000 });
  if (error) throw error;
  const files = [];
  for (const entry of data || []) {
    const isFile = entry.metadata && typeof entry.metadata === 'object';
    const fullPath = prefix ? `${prefix}/${entry.name}` : entry.name;
    if (!isFile) {
      if (fullPath === '__ping__') continue;
      const nested = await listAllBucketFiles(fullPath);
      files.push(...nested);
    } else {
      files.push(fullPath);
    }
  }
  return files;
}

function playerFromFicha(ficha){
  if (!ficha || typeof ficha !== 'object') return null;
  const niveles = ficha.niveles || {};
  const numOrNull = (value)=>{
    const num = Number(value);
    return Number.isFinite(num) ? num : null;
  };
  const takeNivel = (primary, fallback)=> numOrNull(primary ?? fallback);
  const nacimiento = numOrNull(ficha.anio_nacimiento ?? ficha.nacimiento);
  const peso = numOrNull(ficha.peso_kg ?? ficha.peso);
  const altura = numOrNull(ficha.altura_cm ?? ficha.altura);
  const player = {
    id: ficha.id || ficha.uuid || ficha.identifier || null,
    createdAt: ficha.creado || ficha.createdAt || ficha.created_at || new Date().toISOString(),
    nombre: ficha.nombre || '',
    apellido: ficha.apellido || '',
    nacimiento: nacimiento ?? '',
    peso: peso ?? '',
    altura: altura ?? '',
    disparo: takeNivel(niveles.disparo, ficha.disparo),
    tecnica: takeNivel(niveles.tecnica, ficha.tecnica),
    velocidad: takeNivel(niveles.velocidad, ficha.velocidad),
    resistencia: takeNivel(niveles.resistencia, ficha.resistencia),
    sacrificio: takeNivel(niveles.sacrificio, ficha.sacrificio),
    fisico: takeNivel(niveles.fisico, ficha.fisico)
  };
  if (!player.id) return null;
  for (const key of PARAM_KEYS) {
    player[key] = clampStatValue(player[key], 50);
  }
  return player;
}

async function fetchPlayersFromSupabase(){
  if (!supa) return [];
  const files = await listAllBucketFiles('');
  const byId = new Map();
  for (const path of files) {
    if (!path.endsWith('.json')) continue;
    try {
      const { data, error } = await supa.storage.from(SUPABASE_BUCKET).download(path);
      if (error) throw error;
      const text = await data.text();
      const json = JSON.parse(text);
      const player = playerFromFicha(json);
      if (player) {
        player.remotePath = path;
        byId.set(player.id, player);
      }
    } catch (err) {
      console.error('No se pudo cargar ficha desde Supabase:', path, err);
    }
  }
  const players = Array.from(byId.values());
  players.sort((a,b)=> a.apellido.localeCompare(b.apellido)||a.nombre.localeCompare(b.nombre));
  return players;
}

async function syncPlayersFromSupabase(options = {}){
  const { silent = false } = options;
  if (!supa) return;
  try {
    const remotePlayers = await fetchPlayersFromSupabase();
    if (!remotePlayers) return;
    if (!remotePlayers.length) {
      if (!state.players.length) {
        state.players = [];
        state.apuntados = [];
        saveState();
        renderAll();
      }
      return;
    }
    const remoteIds = new Set(remotePlayers.map(p=>p.id));
    state.players = remotePlayers;
    ensureTeamArrays();
    state.apuntados = state.apuntados.filter(id => remoteIds.has(id));
    state.teamAIds = state.teamAIds.filter(id => remoteIds.has(id));
    state.teamBIds = state.teamBIds.filter(id => remoteIds.has(id));
    saveState();
    renderAll();
  } catch (err) {
    console.error('No se pudo sincronizar jugadores desde Supabase:', err);
    if (!silent) {
      alert('No se pudieron cargar los jugadores desde Supabase. Revisa la conexión.');
    }
  }
}

async function initializeRemoteSync(){
  if (!supa) return;
  await syncPlayersFromSupabase({ silent: true });
}

function setupMobileNav(){
  const nav = document.getElementById('mobileNav');
  if (!nav) return;
  const buttons = Array.from(nav.querySelectorAll('[data-scroll-target]'));
  if (!buttons.length) return;
  const targets = new Map();
  buttons.forEach((btn)=>{
    const selector = btn.dataset.scrollTarget;
    if (selector) {
      const el = document.querySelector(selector);
      if (el) targets.set(selector, el);
    }
  });
  const setActive = (activeBtn)=>{
    buttons.forEach((btn)=>{
      const isActive = btn === activeBtn;
      btn.classList.toggle('bg-emerald-50', isActive);
      btn.classList.toggle('border-emerald-300', isActive);
      btn.classList.toggle('text-emerald-700', isActive);
      btn.classList.toggle('font-semibold', isActive);
      btn.classList.toggle('text-slate-700', !isActive);
      btn.classList.toggle('border-slate-200', !isActive);
    });
  };

  setActive(buttons[0]);

  buttons.forEach((btn)=>{
    btn.addEventListener('click', ()=>{
      const selector = btn.dataset.scrollTarget;
      const target = selector ? document.querySelector(selector) : null;
      if (target) {
        target.scrollIntoView({ behavior:'smooth', block:'start' });
        setActive(btn);
      }
    });
  });

  if ('IntersectionObserver' in window && targets.size) {
    const observer = new IntersectionObserver((entries)=>{
      const visible = entries
        .filter(entry => entry.isIntersecting)
        .sort((a,b)=> b.intersectionRatio - a.intersectionRatio);
      if (visible.length) {
        const top = visible[0];
        const selector = `#${top.target.id}`;
        const activeBtn = buttons.find(btn => btn.dataset.scrollTarget === selector);
        if (activeBtn) setActive(activeBtn);
      }
    }, { rootMargin: '-40% 0px -40% 0px', threshold: [0.1, 0.25, 0.5] });
    targets.forEach((el)=> observer.observe(el));
  } else if (buttons.length) {
    setActive(buttons[0]);
  }
}

/* ---------- Render: registrados / apuntados / equipos ---------- */
const playersGrid=document.getElementById('playersGrid');
const searchInput=document.getElementById('searchInput');
const drop=document.getElementById('apuntadosDrop');
const clearApBtn=document.getElementById('clearApuntadosBtn');

function renderPlayers(){
  const q=(searchInput.value||'').toLowerCase();
  const exclude = new Set(state.apuntados);
  const list = state.players
    .filter(p => !exclude.has(p.id))
    .filter(p => (p.nombre+' '+p.apellido).toLowerCase().includes(q))
    .sort((a,b)=> {
      const levelDiff = levelInt(b) - levelInt(a);
      if (levelDiff !== 0) return levelDiff;
      const surname = a.apellido.localeCompare(b.apellido);
      if (surname !== 0) return surname;
      return a.nombre.localeCompare(b.nombre);
    });
  playersGrid.innerHTML = list.length ? list.map(p=>playerCard(p,{context:'registry'})).join('') : `<p class="text-sm text-slate-500">Sin jugadores.</p>`;

  playersGrid.querySelectorAll('[data-add]').forEach(el=> el.addEventListener('click', ()=> addApuntado(el.dataset.add)));
  playersGrid.querySelectorAll('[data-edit]').forEach(el=> el.addEventListener('click', ()=> openEdit(el.dataset.edit)));
  playersGrid.querySelectorAll('[data-drag-id]').forEach(el=>{
    el.addEventListener('dragstart',(ev)=> ev.dataTransfer.setData('text/plain', el.dataset.dragId));
  });
}
searchInput.addEventListener('input', renderPlayers);

function renderApuntados(){
  const list = state.apuntados.map(id=> state.players.find(p=>p.id===id)).filter(Boolean);
  drop.innerHTML = list.map(p=>playerCard(p,{context:'apuntados'})).join('');
  drop.querySelectorAll('[data-remove]').forEach(el=> el.addEventListener('click', ()=> removeApuntado(el.dataset.remove)));
  drop.querySelectorAll('[data-edit]').forEach(el=> el.addEventListener('click', ()=> openEdit(el.dataset.edit)));
  drop.querySelectorAll('[data-drag-id]').forEach(el=>{
    el.addEventListener('dragstart',(ev)=> ev.dataTransfer.setData('text/plain', el.dataset.dragId));
  });
}

function renderTeams(){
  ensureTeamArrays();
  const teamAEl=document.getElementById('teamA');
  const teamBEl=document.getElementById('teamB');
  const sumAEl=document.getElementById('sumA');
  const sumBEl=document.getElementById('sumB');
  const teamAStatsEl=document.getElementById('teamAStats');
  const teamBStatsEl=document.getElementById('teamBStats');
  const balanceInfo=document.getElementById('balanceInfo');
  const teamARadarEl=document.getElementById('teamARadar');
  const teamBRadarEl=document.getElementById('teamBRadar');
  const comparisonRadarEl=document.getElementById('comparisonRadar');
  const comparisonLegendEl=document.getElementById('comparisonLegend');
  const comparisonNoteEl=document.getElementById('comparisonNote');

  const teamAPlayers = playersFromIds(state.teamAIds);
  const teamBPlayers = playersFromIds(state.teamBIds);
  const arraysDiffer = (arr1=[], arr2=[])=>{
    if(arr1.length !== arr2.length) return true;
    for(let i=0;i<arr1.length;i++){
      if(arr1[i] !== arr2[i]) return true;
    }
    return false;
  };
  const normalizedAIds = teamAPlayers.map(p=>p.id);
  const normalizedBIds = teamBPlayers.map(p=>p.id);
  let teamsNormalized = false;
  if(arraysDiffer(state.teamAIds, normalizedAIds)){
    state.teamAIds = normalizedAIds;
    teamsNormalized = true;
  }
  if(arraysDiffer(state.teamBIds, normalizedBIds)){
    state.teamBIds = normalizedBIds;
    teamsNormalized = true;
  }
  if(teamsNormalized) saveState();

  const cardTeamA = (p)=> playerCard(p,{context:'team', team:'A'});
  const cardTeamB = (p)=> playerCard(p,{context:'team', team:'B'});

  if(teamAEl) teamAEl.innerHTML = teamAPlayers.map(cardTeamA).join('');
  if(teamBEl) teamBEl.innerHTML = teamBPlayers.map(cardTeamB).join('');

  const attachTeamDraggables = (container, teamLabel)=>{
    if(!container) return;
    container.querySelectorAll('[data-drag-id]').forEach(el=>{
      el.addEventListener('dragstart',(ev)=>{
        ev.dataTransfer.setData('text/plain', el.dataset.dragId);
        ev.dataTransfer.setData('team-source', teamLabel);
        ev.dataTransfer.effectAllowed = 'move';
      });
    });
  };

  const setupTeamDropZone = (container, teamLabel)=>{
    if(!container) return;
    container.ondragover = (e)=>{
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      container.classList.add('ring-2','ring-emerald-400');
    };
    container.ondragleave = (e)=>{
      if(!container.contains(e.relatedTarget)){
        container.classList.remove('ring-2','ring-emerald-400');
      }
    };
    container.ondrop = (e)=>{
      e.preventDefault();
      container.classList.remove('ring-2','ring-emerald-400');
      const id = e.dataTransfer.getData('text/plain');
      if(id) movePlayerToTeam(id, teamLabel);
    };
  };

  attachTeamDraggables(teamAEl, 'A');
  attachTeamDraggables(teamBEl, 'B');
  setupTeamDropZone(teamAEl, 'A');
  setupTeamDropZone(teamBEl, 'B');

  const renderTeamRadar = (el, players)=>{
    if(!el) return;
    if(players.length){
      const avgParams = averageParams(players);
      el.innerHTML = radarMiniSVG(avgParams, 96);
      el.classList.remove('opacity-30');
      el.title = 'Media de parámetros del equipo';
    }else{
      el.innerHTML = '<div class="w-full h-full rounded-full border border-dashed border-slate-200"></div>';
      el.classList.add('opacity-30');
      el.removeAttribute('title');
    }
  };
  renderTeamRadar(teamARadarEl, teamAPlayers);
  renderTeamRadar(teamBRadarEl, teamBPlayers);

  const balance = balanceMetrics(teamAPlayers, teamBPlayers);
  const avgScoreA = balance.averages.a.skill;
  const avgScoreB = balance.averages.b.skill;
  const avgPesoA = balance.averages.a.peso;
  const avgPesoB = balance.averages.b.peso;
  const avgAlturaA = balance.averages.a.altura;
  const avgAlturaB = balance.averages.b.altura;
  const avgAgeA = averagePositive(teamAPlayers.map(p=> ageFromYear(p.nacimiento)));
  const avgAgeB = averagePositive(teamBPlayers.map(p=> ageFromYear(p.nacimiento)));
  const avgParamsA = averageParams(teamAPlayers);
  const avgParamsB = averageParams(teamBPlayers);

  const statsHtml = (players, metrics)=>{
    if(!players.length) return `<span class="text-sm text-slate-400">Sin jugadores</span>`;
    const metricBlock = (label, value, unit, color)=>{
      const hasValue = Number.isFinite(value);
      const colorAttr = (color && hasValue) ? ` style="color:${color}"` : '';
      const valueText = hasValue ? value.toFixed(1) : '—';
      const unitSpan = (unit && hasValue) ? `<span class="ml-1 text-[10px] uppercase tracking-[0.25em] text-slate-400">${unit}</span>` : '';
      return `
        <div class="flex flex-col items-start">
          <span class="flex items-baseline gap-1">
            <span class="text-2xl font-semibold leading-none text-slate-900"${colorAttr}>${valueText}</span>
            ${unitSpan}
          </span>
          <span class="text-sm font-semibold text-slate-900">${label}</span>
        </div>
      `;
    };
    const levelColorValue = Number.isFinite(metrics.level) ? levelColor(metrics.level) : null;
    const blocks = [
      metricBlock('Nivel medio', metrics.level, '', levelColorValue),
      metricBlock('Peso medio', metrics.peso, 'kg', '#0284c7'),
      metricBlock('Altura media', metrics.altura, 'cm', '#7c3aed'),
      metricBlock('Edad media', metrics.edad, 'años', '#d97706')
    ];
    return `<div class="flex flex-wrap items-end gap-x-6 gap-y-3">${blocks.join('')}</div>`;
  };

  if(teamAStatsEl) teamAStatsEl.innerHTML = statsHtml(teamAPlayers, { level: avgScoreA, peso: avgPesoA, altura: avgAlturaA, edad: avgAgeA });
  if(teamBStatsEl) teamBStatsEl.innerHTML = statsHtml(teamBPlayers, { level: avgScoreB, peso: avgPesoB, altura: avgAlturaB, edad: avgAgeB });

  const ageText = (avgAge)=>{
    if(avgAge==null) return 'Edad media sin datos';
    return `Edad media ${avgAge.toFixed(1)} años`;
  };
  if(sumAEl) sumAEl.textContent = teamAPlayers.length ? `${teamAPlayers.length} jugadores · ${ageText(avgAgeA)}` : '';
  if(sumBEl) sumBEl.textContent = teamBPlayers.length ? `${teamBPlayers.length} jugadores · ${ageText(avgAgeB)}` : '';

  if (balanceInfo) {
    if (teamAPlayers.length && teamBPlayers.length) {
      const parts = [`⭐ ${balance.detail.skill.toFixed(2)}`];
      if (balance.detail.peso != null) parts.push(`Peso ${balance.detail.peso.toFixed(2)} kg`);
      if (balance.detail.altura != null) parts.push(`Altura ${balance.detail.altura.toFixed(2)} cm`);
      balanceInfo.textContent = `Diferencias medias → ${parts.join(' | ')}`;
    } else {
      balanceInfo.textContent = '';
    }
  }

  if (comparisonRadarEl) {
    if (teamAPlayers.length && teamBPlayers.length && avgParamsA && avgParamsB) {
      comparisonRadarEl.innerHTML = radarOverlaySVG(avgParamsA, avgParamsB, 280);
      if (comparisonLegendEl) {
        comparisonLegendEl.innerHTML = `
          <span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-[#2563eb]"></span>Blanco</span>
          <span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-[#f97316]"></span>Peto</span>
        `;
      }
      if (comparisonNoteEl) {
        comparisonNoteEl.textContent = 'Comparativa de medias técnicas (0–100) superpuestas: disparo, técnica, velocidad, resistencia, sacrificio y físico.';
      }
    } else {
      comparisonRadarEl.innerHTML = '<div class="text-sm text-slate-400 text-center">Genera ambos equipos para comparar sus perfiles.</div>';
      if (comparisonLegendEl) comparisonLegendEl.innerHTML = '';
      if (comparisonNoteEl) comparisonNoteEl.textContent = '';
    }
  }
}

function renderAll(){ renderPlayers(); renderApuntados(); renderTeams(); }

/* ---------- Apuntados: lógica + DnD ---------- */
function addApuntado(id){ if(!state.apuntados.includes(id)){ state.apuntados.push(id); saveState(); renderAll(); } }
function removeApuntado(id){ state.apuntados = state.apuntados.filter(x=>x!==id); saveState(); renderAll(); }

drop.addEventListener('dragover',(e)=>{ e.preventDefault(); drop.classList.add('bg-slate-50'); });
drop.addEventListener('dragleave',()=> drop.classList.remove('bg-slate-50'));
drop.addEventListener('drop',(e)=>{ e.preventDefault(); drop.classList.remove('bg-slate-50');
  const id=e.dataTransfer.getData('text/plain');
  if(state.players.some(p=>p.id===id)) addApuntado(id);
});
clearApBtn.addEventListener('click',()=>{ state.apuntados=[]; saveState(); renderAll(); });

// Devolver desde Apuntados soltando sobre Registrados
playersGrid.addEventListener('dragover', (e) => {
  e.preventDefault();
  playersGrid.classList.add('ring-2', 'ring-emerald-400');
});
playersGrid.addEventListener('dragleave', () => {
  playersGrid.classList.remove('ring-2', 'ring-emerald-400');
});
playersGrid.addEventListener('drop', (e) => {
  e.preventDefault();
  playersGrid.classList.remove('ring-2', 'ring-emerald-400');
  const id = e.dataTransfer.getData('text/plain');
  if (state.apuntados.includes(id)) {
    removeApuntado(id);
  }
});

/* ---------- Abrir edición desde botón info (ⓘ) ---------- */
function openEdit(id){
  const p=state.players.find(x=>x.id===id); if(!p) return;
  formTitle.textContent='Editar jugador';
  fillForm(p);
  showForm();
}

/* ---------- Equipos ---------- */
const makeBtn=document.getElementById('makeTeamsBtn');
const shuffleBtn=document.getElementById('shuffleTeamsBtn');
makeBtn.addEventListener('click',()=> makeTeams());
shuffleBtn.addEventListener('click',()=> makeTeams(Date.now()));

function makeTeams(seed=null){
  const selected=state.apuntados.map(id=> state.players.find(p=>p.id===id)).filter(Boolean);
  if(selected.length!==10){ alert('Debes tener exactamente 10 apuntados para crear 2 equipos de 5.'); return; }
  const players=selected.slice(); let bestCandidates=[]; let bestDiff=Infinity; const tries=1024;
  const rnd=(s)=>{ let x=s||Date.now(); return ()=> (x^=x<<13, x^=x>>>17, x^=x<<5, (x>>>0)/0xFFFFFFFF); };
  for(let i=0;i<tries;i++){
    const randomSeed = (seed||state.lastSeed)+i;
    const r=rnd(randomSeed); const arr=players.slice();
    for(let j=arr.length-1;j>0;j--){ const k=Math.floor(r()*(j+1)); [arr[j],arr[k]]=[arr[k],arr[j]]; }
    arr.sort((p,q)=>{
      const diff = avgSkill(q)-avgSkill(p);
      if(Math.abs(diff) < 0.01) return r()-0.5;
      return diff;
    });
    const teamA=[], teamB=[];
    for(const p of arr){
      if(teamA.length>=5){ teamB.push(p); continue; }
      if(teamB.length>=5){ teamA.push(p); continue; }
      const diffIfA = teamSkillDiff([...teamA, p], teamB);
      const diffIfB = teamSkillDiff(teamA, [...teamB, p]);
      if(diffIfA<=diffIfB){ teamA.push(p); }
      else { teamB.push(p); }
    }
    const diff=teamSkillDiff(teamA, teamB);
    if(diff < bestDiff - 1e-6){
      bestDiff = diff;
      bestCandidates = [{ a: [...teamA], b: [...teamB] }];
    } else if (Math.abs(diff - bestDiff) <= TEAM_BALANCE_TOLERANCE){
      bestCandidates.push({ a: [...teamA], b: [...teamB] });
    }
    if(bestDiff<0.01) break;
  }
  state.lastSeed=(state.lastSeed+7919)%1_000_000_007;
  let chosen = null;
  if(bestCandidates.length){
    chosen = bestCandidates[Math.floor(Math.random()*bestCandidates.length)] || bestCandidates[0];
  } else {
    chosen = {
      a: players.slice(0,5),
      b: players.slice(5,10)
    };
  }
  state.teamAIds = chosen.a.map(p=>p.id);
  state.teamBIds = chosen.b.map(p=>p.id);
  saveState();
  renderTeams();
}

/* ---------- Init ---------- */
renderAll();
initializeRemoteSync();
setupMobileNav();
</script>
</body>
</html>
